<!DOCTYPE html>
<head>
	<meta http-equiv="content-type" content="text/html; charset=utf-8" />
	<title>7th Day Sabbath Timer</title>
		<style type="text/css">
		</style>
	</head>
	<body onload="init()">
	 	<div class="geo">
			<div id="getlocation">
				<button type="button" onclick="locations.builder()">位置情報を取得</button>
			</div>
			<div id="selectlocation">
				<select id="cities" onchange="display.init()"></select>
			</div>
		</div>
		<div class="daycount">
			<span id="comment"></span>
			<br>
			<span id="days"></span>
		</div>
		<div class="timecount">
			<span id="hours"></span>
			<span id="minutes"></span>
			<span id="seconds"></span>
		</div>
		<div class="today">
			<span id="date"></span>
		</div>
		<div class="dev">
		<span>last edit comment = time adjustment</span>
		<br>
		<button type="button" onclick="dev()">dev function</button>
		</div>
		
		<script type="text/javascript">
			function sind(d) {
				return Math.sin(d*Math.PI/180);
			}
			function cosd(d) {
				return Math.cos(d*Math.PI/180);
			}
			function tand(d) {
				return Math.tan(d*Math.PI/180);
			}
			
			var date = {
				getNextDay: function(day) { // 0 (Sun) - 6 (Sat)
					var tw = new Date();
					var d;
					if (day >= tw.getDay()) { // same or upcoming day of the week
						d = day - tw.getDay();
					} else { // day of the next week
						d = day + 7 - tw.getDay();
					}
					tw.setDate(tw.getDate() + d);
					return tw;
				},
			}
			
			var sunset = {
				lat: "",
				lon: "",
				alt: "",
				def: "",
				yr: "",
				mo: "",
				dd: "",
				total: "",
				
				loader: function() { // return syntax: y, m, d, lat, lon, alt, def
					sunset.yr = now.ymd()[0];
					sunset.mo = now.ymd()[1];
					sunset.dd = now.ymd()[2];
					sunset.lat = locations.reader()[0];
					sunset.lon = locations.reader()[1];
					sunset.alt = locations.reader()[2];
					sunset.def = locations.reader()[3];
					return [sunset.yr, sunset.mo, sunset.dd, sunset.lat, sunset.lon, sunset.alt, sunset.def];
				},
				
				jy: function(yy,mm,dd,h,m,s,i) { // yy/mm/dd h:m:s, i: time difference
					yy -= 2000;
					if(mm <= 2) {
						mm += 12;
						yy--; 
					}
					k = 365 * yy + 30 * mm + dd - 33.5 - i / 24 + Math.floor(3 * (mm + 1) / 5) + Math.floor(yy / 4) - Math.floor(yy / 100) + Math.floor(yy / 400);
					k += ((s / 60 + m) / 60 + h) / 24; // plus time
					k += (65 + yy) / 86400; // plus delta T
					return k / 365.25;
				},
				spls: function(t) { // t: Julius year
					l = 280.4603 + 360.00769 * t 
						+ (1.9146 - 0.00005 * t) * sind(357.538 + 359.991 * t)
						+ 0.0200 * sind(355.05 +  719.981 * t)
						+ 0.0048 * sind(234.95 +   19.341 * t)
						+ 0.0020 * sind(247.1  +  329.640 * t)
						+ 0.0018 * sind(297.8  + 4452.67  * t)
						+ 0.0018 * sind(251.3  +    0.20  * t)
						+ 0.0015 * sind(343.2  +  450.37  * t)
						+ 0.0013 * sind( 81.4  +  225.18  * t)
						+ 0.0008 * sind(132.5  +  659.29  * t)
						+ 0.0007 * sind(153.3  +   90.38  * t)
						+ 0.0007 * sind(206.8  +   30.35  * t)
						+ 0.0006 * sind( 29.8  +  337.18  * t)
						+ 0.0005 * sind(207.4  +    1.50  * t)
						+ 0.0005 * sind(291.2  +   22.81  * t)
						+ 0.0004 * sind(234.9  +  315.56  * t)
						+ 0.0004 * sind(157.3  +  299.30  * t)
						+ 0.0004 * sind( 21.1  +  720.02  * t)
						+ 0.0003 * sind(352.5  + 1079.97  * t)
						+ 0.0003 * sind(329.7  +   44.43  * t);
					while(l >= 360) { l -= 360; }
					while(l < 0) { l += 360; }
					return l;
				}, 
				spds: function(t) { // t: Julius year
					r = (0.007256 - 0.0000002 * t) * sind(267.54 + 359.991 * t)
						+ 0.000091 * sind(265.1 +  719.98 * t)
						+ 0.000030 * sind( 90.0)
						+ 0.000013 * sind( 27.8 + 4452.67 * t)
						+ 0.000007 * sind(254   +  450.4  * t)
						+ 0.000007 * sind(156   +  329.6  * t);
					r = Math.pow(10,r);
					return r;
				},  
				spal: function(t) { // t: Julius year
					ls = sunset.spls(t);
					ep = 23.439291 - 0.000130042 * t;
					al = Math.atan(tand(ls) * cosd(ep)) * 180 / Math.PI;
					if((ls >= 0)&&(ls < 180)) {
						while(al < 0) { al += 180 ; }
						while(al >= 180) { al -= 180 ; } 
					} else {
						while(al < 180) { al += 180 ; }
						while(al >= 360) { al -= 180 ; } 
					}
					return al;
				},
				spdl: function(t) { // t: Julius year
					ls = sunset.spls(t);
					ep = 23.439291 - 0.000130042 * t;
					dl = Math.asin(sind(ls) * sind(ep)) * 180 / Math.PI;
					return dl;
				},
				sh: function(t,h,m,s,l,i) { // t: julius year, h: hour, m: minute, s: second,
		                            // l: longitude, i: time difference
					d = ((s / 60 + m) / 60 + h) / 24 ; // elapsed hour (from 0:00 a.m.)
					th = 100.4606 + 360.007700536 * t + 0.00000003879 * t * t - 15 * i ;
					th += l + 360 * d ;
					while(th >= 360) { th -= 360 ; }
					while(th < 0) { th += 360 ; }
					return th;
				},
				eandp: function(alt,ds) { // subfunction for altitude and parallax
					e = 0.035333333 * Math.sqrt(alt) ;
					p = 0.002442818 / ds ;
					return p - e ;
				},
				sa: function(alt,ds) { // alt: altitude (m), ds: solar distance (AU)
					s = 0.266994444 / ds ;
					r = 0.585555555 ;
					k = sunset.eandp(alt,ds) - s - r ;
					return k ;
				},
				soal: function(la,th,al,dl) { // la: latitude, th: sidereal hour,
		                              // al: solar declination, dl: right ascension
					h = sind(dl) * sind(la) + cosd(dl) * cosd(la) * cosd(th - al);
					h = Math.asin(h) * 180 / Math.PI;
					return h;
				},
				sodr: function(la,th,al,dl) { // la: latitude, th: sidereal hour,
		                              // al: solar declination, dl: right ascension
					t = th - al;
					dc = - cosd(dl) * sind(t);
					dm = sind(dl) * sind(la) - cosd(dl) * cosd(la) * cosd(t) ;
					if(dm == 0) {
						st = sind(t);
						if(st > 0) dr = -90;
						if(st == 0) dr = 9999;
						if(st < 0) dr = 90;
					} else {
						dr = Math.atan(dc / dm) * 180 / Math.PI;
						if(dm <0) dr += 180;
					}
					if(dr < 0) dr += 360;
					return dr;
				},
				main: function(date, location) {
					yy = date.getFullYear();
					mm = date.getMonth();
					dd = date.getDate();
					la = location[0];
					lo = location[1];
					alt = location[2];
					i = location[3];
					
					t = sunset.jy(yy,mm,dd-1,23,59,0,i);
					th = sunset.sh(t,23,59,0,lo,i);
					ds = sunset.spds(t);
					ls = sunset.spls(t);
					alp = sunset.spal(t);
					dlt = sunset.spdl(t);
					pht = sunset.soal(la,th,alp,dlt);
					pdr = sunset.sodr(la,th,alp,dlt);
					
					for(hh=0; hh<24; hh++) {
						for(m=0; m<60; m++) {
							t = sunset.jy(yy,mm,dd,hh,m,0,i);
							th = sunset.sh(t,hh,m,0,lo,i);
							ds = sunset.spds(t);
							ls = sunset.spls(t);
							alp = sunset.spal(t);
							dlt = sunset.spdl(t); 
							ht = sunset.soal(la,th,alp,dlt);
							dr = sunset.sodr(la,th,alp,dlt);
							tt = sunset.eandp(alt,ds);
							t1 = tt - 18;
							t2 = tt - 12;
							t3 = tt - 6;
							t4 = sunset.sa(alt,ds);
					   
							if((pht>t4)&&(ht<t4)) { 
								ans = hh + "時" + m + "分 日没(方位" + Math.floor(dr) +"度)\n" ;
								target = new Date(date.getFullYear(), date.getMonth(), date.getDate(), hh, m);
							}
							pht = ht ;
							pdr = dr ;
						}
					}
					sunset.total = target;
					return target;
					
				},
			}
			
			var now = {
				yy: "",
				mm: "",
				dd: "",
				ymd: function() {
					nw = new Date();
					now.yy = nw.getFullYear();
					now.mm = nw.getMonth() + 1;
					now.dd = nw.getDate();
					format = [now.yy, now.mm, now.dd];
					return format;
				},
				hms: function() {
					nw = new Date();
					var hr = nw.getHours();
					var min = nw.getMinutes();
					var sec = nw.getSeconds();
					var format = [hr, min, sec];
					return format;
				},
				gmtdiff: function() {
					nw = new Date();
					format = nw.getTimezoneOffset()/(-60);
					return format;
				},
				day: function() {
					nw = new Date();
					format = nw.getDay();
					return format;
				}
			}
			
			var geo = {
				longitude: "",
				latitude: "",
				success: "tba",
				
				getPosition: function() {
					navigator.geolocation.getCurrentPosition(
					// 取得成功した場合
						function(position) {
							//alert("緯度:"+position.coords.latitude+",経度"+position.coords.longitude);
							geo.longitude = position.coords.longitude;
							geo.latitude = position.coords.latitude;
							var lat = Math.floor(position.coords.latitude*10000)/10000;
							var lon = Math.floor(position.coords.longitude*10000)/10000; 
							locations.cities[0]["lat"] = lat;
							locations.cities[0]["lon"] = lon;
							locations.cities[0]["alt"] = 0.0;
							locations.cities[0]["def"] = now.gmtdiff();
							locations.cities[0]["name"] = geo.getCityName();
							geo.success = true;
						},
					// 取得失敗した場合
						function(error) {
							geo.success = false;
							switch(error.code) {
								case 1: //PERMISSION_DENIED
									alert("位置情報の利用が許可されていません");
									break;
								case 2: //POSITION_UNAVAILABLE
									alert("現在位置が取得できませんでした");
									break;
								case 3: //TIMEOUT
									alert("タイムアウトになりました");
									break;
								default:
									alert("その他のエラー(エラーコード:"+error.code+")");
									break;
							}
						},
						function(option) {
							return geo.success;
						}
					);
					return geo.success;
				},
				getCityName: function() {
					return "現在の位置";
				}
			}
			
			var locations = {
				init: true,
				targetid: "",
				cities: [
					{"id": 0, "lat": 0, "lon": 0, "alt": 0.0, "def": 0, "name": ""},
					{"id": 1, "lat": 26.2167, "lon": 127.6667, "alt": 0.0, "def": 9, "name": "那覇"},
					{"id": 2, "lat": 31.3600, "lon": 130.3300, "alt": 0.0,"def": 9, "name": "鹿児島"},
					{"id": 3, "lat": 33.3500, "lon": 130.2300, "alt": 0.0, "def": 9, "name": "福岡"},
					{"id": 4, "lat": 33.3300, "lon": 133.3100, "alt": 0.0, "def": 9, "name": "高知"},
					{"id": 5, "lat": 34.2300, "lon": 132.2700, "alt": 0.0, "def": 9, "name": "広島"},
					{"id": 6, "lat": 34.4100, "lon": 135.2900, "alt": 0.0, "def": 9, "name": "大阪"},
					{"id": 7, "lat": 35.0000, "lon": 135.4600, "alt": 0.0, "def": 9, "name": "京都"},
					{"id": 8, "lat": 35.1100, "lon": 136.5400, "alt": 0.0, "def": 9, "name": "名古屋"},
					{"id": 9, "lat": 34.5800, "lon": 138.2300, "alt": 0.0, "def": 9, "name": "静岡"},
					{"id": 10, "lat": 35.6544, "lon": 139.7447, "alt": 0.0, "def": 9, "name": "東京"},
					{"id": 11, "lat": 36.3300, "lon": 136.3900, "alt": 0.0, "def": 9, "name": "金沢"},
					{"id": 12, "lat": 36.3900, "lon": 138.1100, "alt": 0.0, "def": 9, "name": "長野"},
					{"id": 13, "lat": 37.4500, "lon": 140.2800, "alt": 0.0, "def": 9, "name": "福島"},
					{"id": 14, "lat": 39.4300, "lon": 140.0600, "alt": 0.0, "def": 9, "name": "秋田"},
					{"id": 15, "lat": 40.4900, "lon": 140.4400, "alt": 0.0, "def": 9, "name": "青森"},
					{"id": 16, "lat": 43.0300, "lon": 141.2100, "alt": 0.0, "def": 9, "name": "札幌"},
					{"id": 17, "lat": 51.3000, "lon": -0.1000, "alt": 0.0, "def":  0, "name": "ロンドン"},
					{"id": 18, "lat": -33.5700, "lon": 18.2700, "alt": 0.0, "def": 2, "name": "ケープタウン"},
					{"id": 19, "lat": -33.5300, "lon": 151.1000, "alt": 0.0, "def": 10, "name": "シドニー"},
					{"id": 20, "lat": 39.5500, "lon": 116.2600, "alt": 0.0, "def": 8, "name": "ペキン"},
					{"id": 21, "lat": 37.3200, "lon": 126.5800, "alt": 0.0, "def": 9, "name": "ソウル"},
					{"id": 22, "lat": 1.1700, "lon": 103.5100, "alt": 0.0, "def": 8, "name": "シンガポール"},
					{"id": 23, "lat": 13.4500, "lon": 100.3200, "alt": 0.0, "def": 7, "name": "バンコク"},
					{"id": 24, "lat": 55.4400, "lon": 37.4200, "alt": 0.0, "def": 3, "name": "モスクワ"},
					{"id": 25, "lat": 60.1000, "lon": 24.5600, "alt": 0.0, "def": 2, "name": "ヘルシンキ"},
					{"id": 26, "lat": 38.0000, "lon": 23.4300, "alt": 0.0, "def": 2, "name": "アテネ"},
					{"id": 27, "lat": -1.1700, "lon": 36.5100, "alt": 0.0, "def": 3, "name": "ナイロビ"},
					{"id": 28, "lat": 37.4500, "lon": -122.2600, "alt": 0.0, "def": -8, "name": "サンフランシスコ"},
					{"id": 29, "lat": 38.5400, "lon": -77.0000, "alt": 0.0, "def": -5, "name": "ワシントン"},
					{"id": 30, "lat": -23.3200, "lon": -46.3800, "alt": 0.0, "def": -3, "name": "サンパウロ"},
					{"id": 31, "lat": -12.0600, "lon": -77.0200, "alt": 0.0, "def": -5, "name": "リマ"},
				],
				builder: function() {
					console.log('locations builder init = ' + locations.init);
					if (locations.init == false) {
						var s = geo.getPosition();
					} else {
						var s = false;
						
					}
					var select = document.getElementById(locations.targetid);
					while (0 < select.childNodes.length) { // cleanup
						select.removeChild(select.childNodes[0]);
					}
					
					for(var i = 0; i < locations.cities.length; i++) { // construct
		    			var op = document.createElement("option");
		    			op.value = locations.cities[i]["id"];
		    			op.text = locations.cities[i]["name"];
		    			select.appendChild(op);
					}
					if (s == true) { // current location set
						select.selectedIndex = 0;
					} else if (s == false) { // current location not obtained
						if (locations.init == true) {
							select.selectedIndex = 10;
						}
					} else {
						console.log('geo.getposition result undefined ' + geo.getPosition())
					}
					locations.init = false;
				},
				reader: function() {
					var ref = document.getElementById(locations.targetid).value;
					target = [];
					for (var i = 0; i < locations.cities.length; i++) {
						if (locations.cities[i]["id"] == ref) {
							target.push(locations.cities[i]["lat"]);
							target.push(locations.cities[i]["lon"]);
							target.push(locations.cities[i]["alt"]);
							target.push(locations.cities[i]["def"]);
							return target;
						}
					}
				}
			}
			
			var timer = {
				day: "",
				hr: "",
				min: "",
				sec: "",
				
				preSabbath: function() {
					today = new Date();
					if (today < sunset.main(date.getNextDay(5), locations.reader())) {
						return true;
					} else if (today < sunset.main(date.getNextDay(6), locations.reader())) {
						return false;
					} else if (today > sunset.main(date.getNextDay(6), locations.reader())) {
						return true;
					} else {
						//console.log('Error: function preSabbath');
					}
				},
				difft: function(day) {
					var nw = new Date();
					var diff = sunset.main(date.getNextDay(day), locations.reader());
					diff.setYear(diff.getFullYear() - nw.getFullYear());
					diff.setMonth(diff.getMonth() - nw.getMonth());
					diff.setDate(diff.getDate() - nw.getDate());
					diff.setHours(diff.getHours() - nw.getHours());
					diff.setMinutes(diff.getMinutes() - nw.getMinutes());
					diff.setSeconds(diff.getSeconds() - nw.getSeconds());
					return diff;
				},
				timer: function() {
					//console.log('timer.timer called');
					var dday, dhr, dmin, dsec;
					if (timer.preSabbath() == true) {
						dday = timer.difft(5).getDate();
						dhr = timer.difft(5).getHours();
						dmin = timer.difft(5).getMinutes();
						dsec = timer.difft(5).getSeconds();
					} else {
						dday = timer.difft(6).getDate();
						dhr = timer.difft(6).getHours();
						dmin = timer.difft(6).getMinutes();
						dsec = timer.difft(6).getSeconds();
					}
					//console.log('timer.timer dday' + dday);
					return	[dday, dhr, dmin, dsec];
				}
			}
			var display = {
				id0: "",
				id1: "",
				id2: "",
				id3: "",
				id4: "",
				init: function() {
					//console.log('display.init called');
					display.message(display.id0);
					display.timer(display.id1, display.id2, display.id3, display.id4);
					display.today();
				},
				message: function(id0) {
					//console.log('display.message called');
					var text;
					if (timer.preSabbath() == true) {
						text = "安息日まで";
					} else {
						text = "安息日終了まで";
					}
					document.getElementById(id0).innerText = text;
				},
				timer: function(id1, id2, id3, id4) {
					//console.log('display.timer called');
					ddd = timer.timer()[0] + "日";
					dhh = timer.timer()[1] + "時間";
					dmm = timer.timer()[2] + "分";
					dss = timer.timer()[3] + "秒";
					document.getElementById(id1).innerText = ddd;
					document.getElementById(id2).innerText = dhh;
					document.getElementById(id3).innerText = dmm;
					document.getElementById(id4).innerText = dss;
				},
				today: function() {
					//console.log('display.today called');
					yyyy = now.ymd()[0];
					mm = now.ymd()[1];
					dd = now.ymd()[2];
					document.getElementById('date').innerText = yyyy + "年" + mm + "月" + dd + "日";
				}
			}
			
			function init() {
				locations.targetid = 'cities';
				display.id0 = 'comment';
				display.id1 = 'days';
				display.id2 = 'hours';
				display.id3 = 'minutes';
				display.id4 = 'seconds';
				setInterval("display.init()", 1000);
				locations.builder();
				//display.init();
			}
			
			function dev() {
				console.log('date getnextday fri' + date.getNextDay(5));
				console.log('difft5 days' + timer.difft(5).getDate());
			}
		</script>
	</body>
</HTML>